# 00_总览与快速开始

## 0.1 文档目的

本文档用于快速了解并启动 **PDF（扫描/图片型）→ Word（.docx）** 转换桌面软件的开发与使用。内容覆盖：

* 软件目标、适用范围与限制
* 用户使用流程（从导入 PDF 到导出 DOCX）
* 开发环境准备与项目启动步骤
* 核心处理流水线的“端到端”概览（帮助开发快速对齐实现方向）
* 里程碑（M1/M2/M3）建议

---

## 0.2 软件目标与定位

### 目标

构建一个 **Windows 10/11** 桌面端（WPF/.NET 8）工具，用户选择 PDF 文件后，可按指定页码范围将内容转换为 Word（.docx），在“文本与表格大致正确”和“格式尽量接近原文”的前提下，提供稳定、可控、可调参与可重试的转换能力。

### 核心特点

* **面向图片型 PDF**：PDF 每页为图片（扫描件），内容仅包含文字与带边框线的文字表格
* **表格结构稳定**：表格线清晰时由 OpenCV 推断结构与单元格合并，Gemini 仅负责单元格文字识别
* **支持页码范围选择**：例如 `1,3,5-10`
* **支持去页眉/页脚/全部去除**：裁切方式实现，提供可调百分比
* **输出版式尽量还原**：

  * 允许用户选择：强制 A4 或与 PDF 页一致
  * 保留分页（每 PDF 页对应 Word 分页）
  * 表格合并单元格（rowspan/colspan）尽量准确
  * 段落换行、标题/正文样式尽量接近

---

## 0.3 适用范围与限制

### 适用范围（强匹配场景）

* PDF 每页为整页图片（扫描件/截图型 PDF）
* 内容主要为中文，夹杂少量字母、数字、符号
* 表格均有边框线，且可能包含合并单元格
* 文档通常十来页（也可更大，但性能策略以十来页为主要目标）

### 当前版本限制（明确不追求）

* 不追求完全 1:1 复刻字体、字号、表格线粗细、精确段前段后距离
* 不支持或不保证：

  * 多栏排版、复杂浮动布局
  * 图片、公式、图表、印章/水印等非纯文字内容（如出现可忽略或作为噪声）
  * 极端低清晰度/强倾斜/强噪声文档的高准确率
  * 精确还原脚注、批注、文本框等复杂 Word 特性

> 注：后续可通过“预览调参 + 算法增强”逐步提高覆盖面，但 MVP 以稳定可用为先。

---

## 0.4 用户使用流程（软件视角）

1. **选择 PDF 文件**
2. **设置转换页码范围**

   * 例如：`1,3,5-10`
   * 留空表示全部页
3. **页眉页脚处理选项**

   * 不去除
   * 去页眉
   * 去页脚
   * 全部去除
   * （可选）调整页眉裁切比例、页脚裁切比例（默认建议 6%/6%）
4. **页面尺寸输出选项**

   * 强制 A4
   * 与 PDF 页一致
5. （可选）设置 DPI、并发数
6. 点击 **开始转换**
7. 转换完成后 **保存/打开 DOCX**

建议提供的用户反馈：

* 总页数、已完成页数
* 当前阶段（渲染/表格检测/表格识别/正文识别/生成 Word）
* 失败页或失败表格块可重试提示
* 可选“预览”：展示表格框、裁切区域（便于调整页眉页脚比例）

---

## 0.5 开发快速开始（开发者视角）

### 0.5.1 环境要求

* Windows 10/11
* Visual Studio 2022（建议）或 Rider
* .NET SDK 8.x
* Git（如使用版本管理）

### 0.5.2 关键第三方依赖（NuGet）

（版本在工程中固定，本节仅列出方向）

* WPF：.NET 8 自带
* OpenCV：`OpenCvSharp4`、`OpenCvSharp4.runtime.win`
* Word 生成：`DocumentFormat.OpenXml`
* JSON：`System.Text.Json`（.NET 自带）
* PDF 渲染：选择一种可稳定渲染到 Bitmap 的方案（PDFium wrapper / MuPDF wrapper 等）

### 0.5.3 本地运行（建议步骤）

1. 克隆仓库 / 打开解决方案
2. 还原 NuGet 包
3. 配置 Gemini API Key（推荐支持三种方式，优先级从高到低）：

   * 用户在 UI 输入（并加密保存到本地）
   * 环境变量（例如 `GEMINI_API_KEY`）
   * 配置文件（仅开发阶段，发布版不建议明文存储）
4. 启动 WPF 程序
5. 导入一个样例 PDF 进行端到端测试
6. 观察日志与输出 docx

---

## 0.6 端到端处理流水线概览（核心逻辑一页一页跑）

对用户选择的目标页（来自页码范围解析）执行以下流水线：

### 0.6.1 裁切策略（页眉页脚）

* 根据选项裁切顶部/底部区域（按百分比）
* 裁切后再进入后续流程（能显著减少干扰）

### 0.6.2 表格优先（稳定性关键）

1. **PDF 页渲染为图片（建议 300 DPI）**
2. **图像预处理**：灰度/对比度增强/二值化/去噪/可选 deskew
3. **表格检测**（有边框线）：提取水平/竖直线 → 找到表格 bbox
4. **单元格分割 + 合并推断**：

   * 通过线条与连通域轮廓推断每个单元格 bbox
   * 聚类得到行/列边界 → 计算 rowspan/colspan
   * 得到确定性 TableGrid（结构由程序掌控）
5. **Gemini 表格文字识别**：

   * 输入：表格裁剪图 + 单元格 bbox 列表
   * 输出：每个单元格的 text
6. **正文识别（遮罩表格区域后）**：

   * 将表格区域填白（mask），只让 Gemini 识别剩余文字段落
7. 合并段落块与表格块为 Page IR（按 y 坐标排序）
8. 使用 OpenXML 写入 Word：段落 + 表格 + 分页符

### 0.6.3 为什么这样设计

* 合并单元格结构“最容易出错”，交给确定性算法（OpenCV）更稳定
* Gemini 专注 OCR 文本，不负责结构推断，降低幻觉与格式漂移
* 失败可局部重试：只重试某个表格或某页正文，不重跑整本

---

## 0.7 MVP 里程碑（建议）

### M1：跑通全链路（先可用）

* WPF UI：选择 PDF、页码范围、输出路径、开始/取消
* PDF 渲染 → 整页调用 Gemini 输出段落 → 生成 docx（不做表格分割）
* 目的：快速验证 Gemini 调用、docx 输出、进度与错误处理

### M2：质量跃升（表格检测 + 单元格合并）

* OpenCV 表格 bbox 检测
* 单元格分割 + rowspan/colspan 推断
* 表格 OCR 改为“单元格列表回填”
* 正文遮罩表格后识别
* 目的：解决“合并单元格与表格结构”这一关键质量问题

### M3：产品化体验（可调参、预览、诊断）

* 页眉/页脚裁切选项 + 百分比调节
* 表格/裁切区域预览叠加
* 重试/降级策略完善、失败页定位
* 诊断导出（日志 + 关键中间图 + JSON）
* 目的：让工具在真实复杂样本中可快速定位与调参

---

## 0.8 交付物与输出格式

### 输出文件

* `.docx`（Word 文档）

### 输出原则

* 每个 PDF 页对应 Word 的一个分页（PageBreak）
* 文本段落尽量保持原换行与分段
* 表格：

  * 必须有边框线（默认 Word 表格线即可）
  * 合并单元格尽量正确
* 页面尺寸：

  * 用户选择 A4：统一 A4
  * 用户选择跟随 PDF：按 PDF 页比例映射到 Word PageSize（并设置合理边距）

---

## 0.9 常见问题（Quick FAQ）

### Q1：为什么不直接用 Gemini 把整页转成 Word/HTML？

因为合并单元格与复杂表格结构在 LLM 输出中不稳定，且难以校验。当前方案将“结构”交给可确定的图像算法，将“文字”交给 Gemini，整体更可控、更稳定。

### Q2：页眉页脚为什么用裁切而不是模型判断？

裁切可预测、可调参、可预览，避免误删正文或漏删；并且桌面工具允许用户很方便地调整百分比，使结果更可靠。

### Q3：输出能做到和原 PDF 一模一样吗？

本项目目标是“尽量一致、稳定可用”，不追求完全 1:1 复刻（字体/线粗/微小间距等）。如果需要出版级复刻，需要更复杂的版面建模与更多成本投入。
