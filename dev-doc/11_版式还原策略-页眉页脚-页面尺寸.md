# 11_版式还原策略：页眉页脚、页面尺寸与整体排版

## 11.1 文档目的

本文件定义“尽量像原文一样”的**版式还原策略**，重点聚焦三类你明确关心的维度：

1. 页眉/页脚处理（去除与保留的策略、裁切与风险控制）
2. 页面尺寸（强制 A4 vs 跟随 PDF）与单位换算、横竖版处理
3. 文档整体排版策略（分页、边距、段落、表格宽度与对齐等）

目标：在不追求 1:1 复刻的前提下，使输出 Word 的阅读体验尽可能接近原 PDF，并且可预测、可调参、可复现。

---

## 11.2 核心原则（全局）

### 11.2.1 “可读优先、结构优先、细节后置”

* 可读：字不乱、顺序对、分页对
* 结构：表格行列与合并单元格稳定
* 细节：字体、行距、缩进、线粗等可逐步增强，但不影响稳定性

### 11.2.2 单页自治（减少跨页耦合）

* 默认每 PDF 页对应一个 Word 页（或一个 section）
* 不做跨页内容重排（避免顺序错、合并错）

### 11.2.3 所有“会误删”的操作必须可预览、可调参

* 页眉/页脚去除采用裁切（可视化）
* 裁切比例与 DPI、deskew 等可调（且建议给默认值与提示）

---

## 11.3 页眉/页脚策略（Header/Footer）

### 11.3.1 为什么采用“裁切”而非“识别后删除”

* 图片型 PDF 无原生结构信息
* LLM 判断哪些是页眉/页脚存在误删正文风险
* 裁切是确定性操作，可预览与复现，且对表格检测/正文 OCR 都有明显好处

### 11.3.2 模式定义（与 UI 一致）

* `None`：不去除
* `RemoveHeader`：去页眉（裁切顶部）
* `RemoveFooter`：去页脚（裁切底部）
* `RemoveBoth`：全部去除（裁切顶部+底部）

### 11.3.3 参数定义与默认值

* `HeaderPercent`：默认 `0.06`（6%）
* `FooterPercent`：默认 `0.06`（6%）

建议 UI 范围：

* 0% ～ 20%
* 限制：`HeaderPercent + FooterPercent <= 50%`（建议更严格：<= 30%）

> 默认值建议解释（可写在 UI tooltip）：
> “多数扫描件页眉/页脚高度约占 3%~8%，默认 6%。如果正文被裁掉，请降低比例。”

### 11.3.4 裁切像素计算（可复现）

对裁切前页图高度 `H`：

* `CropTopPx = round(H * HeaderPercent)`（仅去页眉时）
* `CropBottomPx = round(H * FooterPercent)`（仅去页脚时）
* 裁切后高度：`H' = H - CropTopPx - CropBottomPx`

所有后续 bbox 与 IR 坐标均基于裁切后页图（见《03》）。

### 11.3.5 误裁风险与防护

风险：用户设过大导致正文被切掉，识别结果缺失或顺序错乱。
防护（建议实现）：

* 开始前校验：

  * 若 `H' < 0.6 * H`（裁掉超过 40%）→ 阻止开始并提示
* 运行时检测（可选）：

  * 正文 OCR 返回字符数过低（<10）且表格也很少 → 给出建议“可能裁切过大”

### 11.3.6 预览建议（强烈建议）

* 预览页图上用半透明遮罩显示裁切区域
* 切换页码预览：让用户确认不同页的页眉/页脚高度是否一致
* 若不同页差异大：

  * 用户可能需要更小的裁切比例（宁可留一点页眉/脚，也别误删正文）

---

## 11.4 页面尺寸策略（Page Size）

用户需求：提供选项支持 **强制 A4** 或 **与 PDF 页一致**。

### 11.4.1 PageSizeMode 定义

* `A4`：所有页统一 A4（最稳定、便于打印/模板）
* `FollowPdf`：页面宽高随 PDF 页映射（最接近原文）

### 11.4.2 单位换算（像素 → twips）

Word 页面尺寸使用 twips：

* `twips = pixels * 1440 / dpi`

因此：

* `Wtw = round(WidthPx * 1440.0 / Dpi)`
* `Htw = round(HeightPx * 1440.0 / Dpi)`

> 注意：WidthPx/HeightPx 应来自“裁切后页图”（与页眉/页脚策略一致），这样输出页面“就是用户想要保留的内容区域”。

### 11.4.3 横竖版（Orientation）

判断：

* 若 `WidthPx > HeightPx` → 横向页（Landscape）

在 OpenXML 中设置方式（两种都可）：

* 设置 `PageSize.Orient = Landscape`，并写 `Width/Height`
* 或交换 width/height 并标 Landscape
  建议：保持逻辑统一：**写真实的 Width/Height，同时设置 Orient**。

### 11.4.4 FollowPdf 时的 Section 策略

* 若 FollowPdf：

  * **建议每页一个 Section**（NextPage SectionBreak）
  * 每页末尾写入该页的 `SectionProperties(PageSize, Margins)`
    原因：即使目前样本页尺寸一致，也能保证未来“不同页尺寸”不出问题。

* 若 A4：

  * 全文一个 Section 即可（结尾写一次 SectionProperties）
  * 每页用 PageBreak 分隔

### 11.4.5 A4 具体值（twips）

A4：8.27" × 11.69"

* 宽：`11906` twips
* 高：`16838` twips

### 11.4.6 页面边距（Margins）

边距对“像原文一样”影响很大，但扫描件无法精准复刻，因此采用“稳定默认 + 可配置（可选）”。

推荐默认：

* 左右：2.0cm（约 1134 twips）
* 上下：2.0cm（约 1134 twips）

策略建议：

* A4：固定边距
* FollowPdf：也可用同一边距（更一致），或按比例稍小（但不建议自动变化，除非明确需求）

---

## 11.5 分页与页面内容组织策略

### 11.5.1 每 PDF 页对应 Word 页

实现：

* A4：每页末尾插入 PageBreak
* FollowPdf：每页末尾插入 SectionBreak(NextPage)

理由：

* 让用户定位更容易（第几页对应原 PDF 第几页）
* 避免跨页合并导致顺序错乱
* 与诊断与失败重试机制对齐（页级独立）

### 11.5.2 页内顺序

页内按 IR 的 `Blocks` 顺序写入：

* 段落块（ParagraphBlock）
* 表格块（TableBlock）
* ……

> 这要求 IR 的排序是可信的（见《03》与《07》）。

---

## 11.6 段落排版策略（尽量像原文）

### 11.6.1 文本“原样”策略

* 不改写、不润色、不纠错
* 保留识别出的：

  * 标点
  * 空格（少量）
  * 段内换行 `\n`（转为 Word `<w:br/>`）

### 11.6.2 标题与正文（Role）

* `role=title`：使用 Heading1（或自定义 Title1）
* `role=body`：Normal/BodyText

MVP 默认：

* 不做复杂的字号、缩进拟合（避免误判造成更糟的版式）
  增强项（可选）：
* 给 body 段落设置轻微行距（1.2~1.4）
* 中文常规首行缩进（2 字）作为可选开关

### 11.6.3 段落间距

建议默认：

* 段前/段后：0 或很小（避免 Word 自动拉开太多）
* 真实分段靠 paragraphs 数组控制，而不是 spacing

---

## 11.7 表格版式策略（宽度、对齐、边框）

### 11.7.1 表格宽度

目标：表格不要溢出页面，且在视觉上尽量贴近原文宽度。

推荐：

* `TableWidth = PageContentWidth`（页面可用宽度）

  * `PageContentWidth = PageWidth - LeftMargin - RightMargin`
* 列宽：

  * MVP：均分列宽（稳定）
  * 增强：按列边界间距比例分配（更像原表格，但需要 colLinesX 参与换算）

> 你明确“不需要模仿表格线粗细，只需要有表格线”，所以列宽策略比线粗更重要。

### 11.7.2 对齐

* 表格整体：左对齐即可（与多数文档一致）
* 单元格文字：

  * 默认左对齐、垂直居中或顶端（顶端更不容易挤压）
  * 可选：若检测到表头行，可居中（增强项，不建议 MVP 自动做）

### 11.7.3 边框

* 统一 Single 边框（InsideH/InsideV/外框）
* 不做线粗还原

### 11.7.4 合并单元格

* 必须按《10》的 owner 矩阵法生成 GridSpan + VerticalMerge
* 若 owner 冲突：

  * 触发《09》的降级：纯文本表格块（D2）

---

## 11.8 “跟随 PDF”模式下的版式稳定性建议

FollowPdf 更接近原文，但也更容易出现：

* Word 显示比例变化造成视觉差异
* 不同页宽高导致内容缩放感觉不一致

因此建议 UI 给出提示：

* “跟随 PDF：版式更接近原文，但若你希望统一打印或公司模板，请选 A4。”

并建议内部：

* 统一边距（不要随页变化）
* 表格宽度按可用宽度计算（避免溢出）

---

## 11.9 与页眉页脚的组合行为（重要）

页眉/页脚裁切会改变页图高度，从而影响 FollowPdf 页面高度映射。

策略（推荐且一致）：

* 裁切后页图就是“最终内容区域”
* FollowPdf 模式下页面大小也跟随裁切后尺寸（更符合用户“不要页眉页脚”的直觉）

UI 文案可说明：

* “开启去页眉/页脚后，Word 页高度会相应减少（跟随内容区域）。”

如果你希望“页面尺寸仍保持原 PDF 尺寸但内容裁掉”也可以，但会出现：

* Word 页仍很高，上下留出空白区域
  这通常不符合用户预期，因此默认不建议。

---

## 11.10 参数建议表（可放配置默认值）

| 项目               |       默认值 |         建议范围 | 说明                 |
| ---------------- | --------: | -----------: | ------------------ |
| HeaderPercent    |      0.06 |       0–0.20 | 去页眉时生效             |
| FooterPercent    |      0.06 |       0–0.20 | 去页脚时生效             |
| Header+Footer 上限 |      0.30 |        ≤0.50 | 超过阻止开始（建议更严格 0.30） |
| PageSizeMode     | FollowPdf | A4/FollowPdf | 贴近原文优先             |
| Margins          |     2.0cm |    1.5–3.0cm | 可配置（MVP 可固定）       |
| TableWidth       |     页面可用宽 |            - | 避免表格溢出             |

---

## 11.11 本文档验收点

* 去页眉/页脚：

  * 裁切生效且可预览
  * 参数异常能阻止开始并提示
* 页面尺寸：

  * A4：全篇 A4 且分页正确
  * FollowPdf：每页可按 PDF 映射（必要时每页一个 section）
  * 横向页显示正确
* 版式整体：

  * 每 PDF 页对应 Word 页
  * 段落换行保留
  * 表格宽度不溢出，边框存在
  * 合并单元格稳定（失败则按《09》降级）
