# 09_结果校验、重试、降级策略

## 9.1 文档目的

本文档定义本项目在转换过程中对结果进行**校验（Validation）**、遇到错误时的**重试（Retry）**与最终的**降级（Degrade/Fallback）**策略，确保：

* 输出尽可能正确（结构与文本）
* 失败可控、可解释、可定位
* 即使部分模块失败，也能给用户“**至少可读**”的 Word 结果（除非发生致命错误）
* 降低“偶发不稳定（网络/模型输出）”对整体体验的影响

---

## 9.2 总体原则与优先级

### 9.2.1 三个原则

1. **块级策略**：尽量只重试失败的最小单元（表格块/正文块），不重跑整页或整本。
2. **先校验再写入**：Gemini 输出和表格结构必须校验通过才进入 IR 与 docx 渲染；否则重试或降级。
3. **最小可用输出**：降级输出以“可读、可编辑”为目标，必要时牺牲结构/分段，但不输出乱码或损坏 docx。

### 9.2.2 质量优先级（用于降级决策）

从高到低：

1. 文档可打开、可编辑（docx 结构稳定）
2. 阅读顺序正确（块级顺序）
3. 表格结构尽量正确（行列+合并）
4. 分页一致（每 PDF 页对应 Word 页）
5. 段落分段与换行尽量一致
6. 样式细节（字体、行距、缩进）

---

## 9.3 错误分类与错误码（建议）

为了让 UI 能给出明确提示，并支持诊断包，建议定义统一错误分类：

### 9.3.1 错误等级（Severity）

* **Fatal（致命）**：无法继续生成可用输出，Job 失败
* **Recoverable（可恢复）**：可通过重试或降级继续
* **Warning（警告）**：不影响输出，但质量可能下降（例如少量 cell 为空）

### 9.3.2 错误域（Domain）

* `PDF_RENDER`：PDF 渲染失败
* `IMAGE_PREPROCESS`：预处理失败（很少见）
* `TABLE_DETECT`：表格 bbox 检测失败或不稳定
* `TABLE_GRID`：单元格分割/合并推断冲突
* `GEMINI_NET`：网络超时/限流/服务错误
* `GEMINI_JSON`：输出不是合法 JSON 或 schema 不符
* `GEMINI_OCR`：结果缺失/空/乱码比例过高
* `DOCX_WRITE`：OpenXML 写入失败
* `IO`：文件读写、权限等

### 9.3.3 示例错误码（供后续附录落地）

* `E_PDF_RENDER_FAILED`（Fatal/Recoverable：视是否可跳页）
* `E_TABLE_GRID_CONFLICT`（Recoverable）
* `E_GEMINI_TIMEOUT`（Recoverable）
* `E_GEMINI_JSON_INVALID`（Recoverable）
* `E_DOCX_WRITE_FAILED`（Fatal）
* `W_CELL_TEXT_EMPTY`（Warning）
* `W_PARAGRAPH_LOW_CONFIDENCE`（Warning）

---

## 9.4 校验体系（Validation Layers）

校验分为三层：**结构校验 → Gemini 输出校验 → IR 组装校验**。

### 9.4.1 表格结构校验（Table Structure Validation）

输入：`TableDetection` / `TableBlockIr`（结构部分）

必须检查：

1. `NCols >= 1`，`Rows.Count >= 1`
2. 每行 `sum(colspan) == NCols`
3. 每个 cell：

   * `rowspan >= 1`，`colspan >= 1`
4. 越界检查：

   * cell 覆盖范围不超过 `Rows.Count` 和 `NCols`
5. owner 矩阵可构造且无冲突（强制）

   * 若冲突 → `E_TABLE_GRID_CONFLICT`

建议附加检查（用于评分或警告）：

* 行/列数量合理范围（例如 1..50）
* 单元格 bbox 数量与网格格数的比例合理（噪声提示）
* 线条密度评分低 → `W_TABLE_LINE_WEAK`

### 9.4.2 Gemini 输出校验（Gemini Output Validation）

#### A) 表格 OCR（T1）输出校验

输入：`TableCellOcrResult` + `ExpectedCellIds`

必须检查：

1. JSON 可解析，字段 `cells` 存在且为数组
2. 每个元素包含 `id`/`text`，类型正确
3. 覆盖率：

   * `missingRate = missingIds / totalIds`
   * 默认阈值：`missingRate <= 0.05`（5%）
   * 若 > 5%：可恢复错误 `E_GEMINI_OCR_MISSING_IDS`
4. 文本质量：

   * 控制字符过滤后仍保留有效文本（非必须，但用于评分）
   * 替换字符 `�`（U+FFFD）占比过高 → `W_OCR_GARBLED`

#### B) 正文 OCR（T2）输出校验

输入：`PageTextOcrResult`

必须检查：

1. JSON 可解析，`paragraphs` 为数组
2. 每项有 `role`/`text`
3. `role` 非法则归一为 `body`
4. paragraphs 为空或总字符数过低（例如 < 10）：

   * 触发可恢复错误 `E_GEMINI_OCR_EMPTY_TEXT`

### 9.4.3 IR 组装校验（IR Assembly Validation）

输入：`PageIr`

必须检查：

1. `Blocks` 不为空（至少有正文或表格之一）
2. block 排序合法（若有 bbox）
3. 文本过滤后不含大量不可见字符
4. 表格块均已通过结构校验；若某表格降级为纯文本，则以段落块形式存在，不应再标为 table

---

## 9.5 重试策略（Retry Policy）

### 9.5.1 重试粒度与次数

* 重试粒度：**块级**

  * 表格 OCR（T1）按“单表格”重试
  * 正文 OCR（T2）按“单页正文块”重试
* 默认最大重试次数：**1**
* 可配置：0/1/2（建议 UI 暂不暴露，作为高级配置）

### 9.5.2 触发重试的条件（必须）

#### 表格 OCR（T1）重试触发

* `GEMINI_NET`：超时、429、5xx
* `GEMINI_JSON`：非 JSON / schema 不符
* `GEMINI_OCR`：缺失 id > 5% 或返回空 text 占比过高（例如 > 80%）

#### 正文 OCR（T2）重试触发

* 网络/超时/429/5xx
* JSON 不合法
* paragraphs 为空或字符数过低

### 9.5.3 重试时的策略升级（Prompt/输入升级）

重试必须“更强约束或更适配”，避免无意义重复。

#### 表格 OCR 重试升级建议

* 使用“重试版 prompt”（强调必须包含所有 id、只输出 JSON、任何多余字符都视为失败）
* 若表格图尺寸过大：重试前将图片等比缩小到合理范围（例如最长边 2200–2800px）
* 若表格线干扰严重：可对表格图做轻微去线增强（可选）

#### 正文 OCR 重试升级建议

* 更强调“只识别可见文字，不要补全”
* 若页图过大：压缩/缩放后再试
* 若怀疑页眉页脚干扰：提示用户调整裁切比例（并记录建议）

### 9.5.4 退避策略（Backoff）

* 对 429/5xx：指数退避 1–3 秒（桌面端不宜太长）
* 对超时：可立即重试一次，但建议先降低图片大小（若可行）

---

## 9.6 降级策略（Degrade/Fallback）

降级用于：重试后仍失败，但为了整体可用性，继续生成可读输出。

### 9.6.1 表格相关降级（按优先级）

当表格结构或表格 OCR 无法可靠完成时：

#### D1：保留结构，文本部分降级

条件：

* 表格结构校验通过（owner matrix 无冲突）
* 但表格 OCR 缺失较多或乱码严重

做法：

* 仍输出 Word 表格结构与合并单元格
* 对缺失 cell 填空串
* 同时在日志记录 `W_CELL_TEXT_EMPTY`，并可在 UI 提示“表格部分单元格识别失败，可尝试提高 DPI 重试”

#### D2：整表降级为“纯文本表格块”（推荐的最终降级）

条件：

* 表格结构冲突（`E_TABLE_GRID_CONFLICT`）或边界提取失败导致无法可靠推断 rowspan/colspan

做法：

* 让 Gemini 对整张表格图做一次“纯文本输出”（仍严格 JSON）：

  * `{"lines":["...","\t...\t..."]}` 或 `{"text":"..."}`（建议 lines）
* 在 Word 中用段落方式写入：

  * 行间 `\n`
  * 列间 `\t`（可配合 TabStops 或等宽字体增强可读性）
* 并在 IR 中将该表格块标为 paragraph（避免 docx 表格结构损坏）

#### D3（可选最末回退）：插入表格图片（不推荐）

仅当你认为“必须保留视觉”且纯文本也失败时：

* 将表格图片插入 Word（不可编辑）
* 这不符合主要目标（可编辑），默认关闭，仅用于极端情况的“救火开关”

> 默认建议：D1 → D2，不启用 D3。

### 9.6.2 正文相关降级

当正文 OCR 失败：

#### D4：降级为单段全文文本

做法：

* 调用 Gemini 使用更简单协议输出：

  * `{"text":"..."}`（一段）
* Word 中写一个正文段落（保留可能的 `\n`）

#### D5：无法获得任何正文

* 该页仍可只输出表格（如果表格成功）
* 若该页既无正文也无表格：标记页失败（可选择跳过页或终止，见 9.7）

---

## 9.7 页级与任务级策略（继续/终止）

### 9.7.1 单页失败是否阻断任务？

建议默认策略：

* **允许跳过失败页并继续**（因为页数通常十来页，用户更希望“先拿到能用的部分”）
* 在最终报告中列出失败页列表与原因

可提供配置：

* `FailFast = false`（默认）
* 若用户选择 `FailFast = true`：任一页出现不可恢复错误即终止任务

### 9.7.2 致命错误（必须终止）

* PDF 无法打开/页数获取失败
* 输出 docx 文件写入失败（权限/磁盘）
* OpenXML 写入抛出不可恢复异常导致 docx 可能损坏

---

## 9.8 质量评分（可选但很有用）

为了给 UI “提示用户如何提升效果”，建议在后台维护简单质量评分：

### 9.8.1 表格质量分

* 结构是否无冲突（0/1）
* cell text 空比例
* 乱码字符比例（控制字符、U+FFFD）
* 线条密度评分（来自表格模块）

输出建议：

* “建议提高 DPI”
* “建议调小/调大页眉页脚裁切”
* “建议开启/关闭 deskew”

### 9.8.2 正文质量分

* 总字符数
* U+FFFD 比例
* 是否出现大量 `?`（若重试 prompt 使用了 ? 占位）

---

## 9.9 用户提示与日志记录（与 UI 对接）

### 9.9.1 UI 提示建议（分级）

* **成功但有警告**：如“第 3 页表格部分单元格未识别，建议提高 DPI 重试”
* **部分失败**：如“第 7 页处理失败已跳过，导出文档不含该页内容”
* **任务失败**：如“无法写入输出文件，请检查路径权限”

### 9.9.2 日志必须记录的信息

* pageNumber、tableIndex
* 失败阶段（render/table_detect/table_grid/gemini_t1/gemini_t2/docx）
* 错误码与异常摘要
* 重试次数与重试后结果
* 降级类型（D1/D2/D4 等）

> 避免记录敏感正文；若开启“保留诊断文件”，可保存 RawJson 与中间图，但要提示用户可能含敏感信息。

---

## 9.10 推荐配置项（默认值建议）

* `MaxRetryCount`：1
* `GeminiMissingIdThreshold`：0.05（5%）
* `GeminiEmptyTextRateThreshold`：0.80（80%）
* `MinPageTextCharCount`：10
* `FailFast`：false
* `EnableTableImageFallback`：false（默认不启用 D3）
* `BackoffBaseMs`：500（用于 429/5xx 退避）

（详细默认值表建议放到 Appendix/A1）

---

## 9.11 伪代码（整体策略示意）

```csharp
ProcessPage(page):
  render -> preprocess -> detect tables -> build grids

  foreach table in tables:
     if !ValidateGrid(table.grid):
        if TryAdjustParamsAndRebuildGrid(): ...
        else:
           // D2: pure text table
           textLines = GeminiTableAsLines(table.image) with retry
           blocks.Add(ParagraphBlock(textLines))
           continue

     // grid ok
     ocr = GeminiTableCells(table.image, table.cells) with retry
     if !ValidateTableOcr(ocr):
        // D1: keep structure, empty cells
        FillCellsEmptyOrPartial()
     else:
        FillCellTexts(ocr)

     blocks.Add(TableBlock(table.grid))

  maskedPage = MaskTablesOnPage(...)
  text = GeminiPageParagraphs(maskedPage) with retry
  if !ValidatePageText(text):
      // D4: single paragraph fallback
      text2 = GeminiPageAsSingleText(maskedPage) with retry
      blocks.Add(ParagraphBlock(text2 or ""))

  if blocks empty:
      MarkPageFailed or SkipPage

  return PageIr(blocks)
```

---

## 9.12 本模块验收点

* Gemini 偶发返回非 JSON 时：能重试并恢复
* 表格结构冲突时：能降级为纯文本表格块，且 docx 不损坏
* 表格 OCR 缺失部分 id 时：保留结构输出，空单元格可接受
* 正文 OCR 为空时：能降级为单段文本
* 默认情况下任务能完成，即使个别页失败也能导出 docx 并提示失败页
* 日志足够定位问题，且不泄露敏感正文
