# A1_配置项与默认值表

> 本附录列出本项目建议的全部配置项、默认值、范围/约束、以及对质量与性能的影响。  
> 目的：让参数**可配置、可调优、可复现**，避免散落在代码里难以维护。  
> 建议实现：全局默认值放 `appsettings.json`（或等价配置文件），用户偏好放本地 user-scope；每次任务快照写入 `DocumentMeta.Options`（见《03》）。

---

## A1.1 配置分层与覆盖规则

### A1.1.1 分层
1) **内置默认值**（代码常量，仅作为兜底）
2) **全局配置**（例如 `appsettings.json`）
3) **用户偏好**（UI 记忆：最近 DPI、并发、裁切比例等）
4) **本次任务参数**（UI 当前表单输入）

### A1.1.2 覆盖优先级
本次任务参数 > 用户偏好 > 全局配置 > 内置默认值

### A1.1.3 任务快照（强烈建议）
每次 Job 开始时，将最终生效的参数写入：
- `DocumentIr.Meta.Options`（或同等结构）
- `meta.json`（诊断包中）

---

## A1.2 核心转换配置（用户可见）

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `Input.PageRange` | string | `""` | 空=全部页；语法见《05》 | 页码范围输入，支持 `1,3,5-10` |
| `Layout.HeaderFooterMode` | enum | `None` | None/RemoveHeader/RemoveFooter/RemoveBoth | 去页眉页脚模式 |
| `Layout.HeaderPercent` | double | `0.06` | 0–0.20 | 顶部裁切比例，仅去页眉/全部去除时生效 |
| `Layout.FooterPercent` | double | `0.06` | 0–0.20 | 底部裁切比例，仅去页脚/全部去除时生效 |
| `Layout.MaxCropTotalPercent` | double | `0.30` | ≤0.50（建议≤0.30） | 防误裁保护：header+footer 超过则阻止开始 |
| `Layout.PageSizeMode` | enum | `FollowPdf` | A4/FollowPdf | Word 页面尺寸模式（见《11》） |
| `Layout.MarginTopTwips` | int | `1134` | 720–1440 | 约 2.0cm；twips |
| `Layout.MarginBottomTwips` | int | `1134` | 720–1440 | 约 2.0cm；twips |
| `Layout.MarginLeftTwips` | int | `1134` | 720–1440 | 约 2.0cm；twips |
| `Layout.MarginRightTwips` | int | `1134` | 720–1440 | 约 2.0cm；twips |
| `Render.Dpi` | int | `300` | 200/300/400 | DPI 越高识别越稳但更慢更耗内存 |
| `Runtime.PageConcurrency` | int | `2` | 1/2/4 | 页级并发，影响 CPU/内存峰值 |
| `Runtime.GeminiConcurrency` | int | `2` | 1–4 | Gemini 请求全局并发限流，影响超时/429 |
| `Preprocess.EnableDeskew` | bool | `true` | true/false | 倾斜校正，对表格线提取有帮助 |
| `Output.OutputDirectory` | string | `""` | 空=与输入同目录 | 输出目录；也可保存到最近使用路径 |
| `Output.FileNameMode` | enum | `Auto` | Auto/Custom | Auto：输入同名+后缀；Custom：用户指定 |
| `Output.Overwrite` | bool | `false` | true/false | 同名文件是否覆盖（建议默认不覆盖） |

---

## A1.3 PDF 渲染与图像管线配置（半可见/高级）

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `Render.ColorMode` | enum | `Color` | Color/Grayscale | 通常 Color 更适合 Gemini；内部可再转灰度 |
| `Render.MaxPreviewDpi` | int | `150` | 96–200 | 预览用低 DPI，提升预览响应 |
| `Preprocess.ContrastEnhance` | enum | `CLAHE` | None/Linear/CLAHE | 扫描件推荐 CLAHE |
| `Preprocess.CLAHE.ClipLimit` | double | `2.5` | 1.5–4.0 | 过大可能放大噪声 |
| `Preprocess.CLAHE.TileGridSize` | int | `8` | 8/16 | 网格越大越“局部” |
| `Preprocess.Denoise` | enum | `Median3` | None/Gaussian3/Median3 | 轻量去噪，避免断线 |
| `Preprocess.Binarize` | enum | `Adaptive` | Adaptive/Otsu | 扫描件光照不均推荐 Adaptive |
| `Preprocess.Adaptive.BlockSize` | int | `41` | 31–51（随 DPI 调整） | DPI 200→31，300→41，400→51 |
| `Preprocess.Adaptive.C` | int | `10` | 5–15 | 背景越灰可适当提高 |
| `Preprocess.Deskew.MinAngleDeg` | double | `0.3` | 0.1–0.5 | 小于该角度不旋转 |
| `Preprocess.Deskew.MaxAngleDeg` | double | `10.0` | 5–15 | 超过视为检测异常，建议回退不 deskew |

---

## A1.4 表格检测与单元格分割配置（算法核心）

> 这些参数建议先隐藏在配置文件中，待样例库积累后再逐步暴露为“高级调参”。

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `TableDetect.Enable` | bool | `true` | true/false | 关闭后只做正文 OCR |
| `TableDetect.MinAreaRatio` | double | `0.005` | 0.002–0.02 | 表格候选 bbox 面积阈值（相对页面面积） |
| `TableDetect.MinWidthPx` | int | `150` | 80–300 | 过滤小框噪声 |
| `TableDetect.MinHeightPx` | int | `80` | 50–200 | 过滤小框噪声 |
| `TableDetect.MergeGapPx` | int | `15` | 5–30 | 相邻 bbox 合并距离阈值 |
| `TableLines.KernelDivisor` | int | `30` | 20–40 | kernel = W/div 或 H/div，用于线条提取 |
| `TableLines.MinKernelPx` | int | `20` | 10–40 | kernel 最小值，避免过小无效 |
| `TableLines.DilateKernelPx` | int | `3` | 3/5/7 | 连接断线；过大易黏连 |
| `TableGrid.ClusterEpsPx` | int | `4` | 3–10 | 边界线聚类 eps；400DPI 可调大 |
| `TableGrid.MinCellSizeRatio` | double | `0.02` | 0.01–0.05 | 过滤过小 cell（相对表格宽高） |
| `TableGrid.OwnerConflictPolicy` | enum | `FailAndFallbackText` | FailAndFallbackText/RetryWithTuning | owner 冲突时策略（见《09》） |
| `TableFallback.EnableTextTable` | bool | `true` | true/false | 结构失败时启用“纯文本表格”降级 |
| `TableFallback.EnableImageTable` | bool | `false` | true/false | 最末回退：插入图片（默认关闭） |

---

## A1.5 Gemini 调用配置（网络与协议）

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `Gemini.Endpoint` | string | `""` | 依你使用的 Gemini API | 由实现决定，建议可配置 |
| `Gemini.ApiKeyStorage` | enum | `DPAPI` | DPAPI/None/EnvOnly | Key 存储策略（见“工程与运维”） |
| `Gemini.TimeoutSeconds.Table` | int | `90` | 60–180 | 表格 OCR 超时 |
| `Gemini.TimeoutSeconds.Page` | int | `90` | 60–180 | 正文 OCR 超时 |
| `Gemini.MaxRetryCount` | int | `1` | 0–2 | 可恢复错误重试次数 |
| `Gemini.BackoffBaseMs` | int | `500` | 200–2000 | 429/5xx 退避基数 |
| `Gemini.ExpectStrictJson` | bool | `true` | true/false | 强制 JSON 输出协议 |
| `Gemini.TableMissingIdThreshold` | double | `0.05` | 0.01–0.20 | 缺失 id 比例阈值，超出触发重试/降级 |
| `Gemini.TableEmptyTextRateThreshold` | double | `0.80` | 0.50–0.95 | 空文本比例过高触发重试/降级 |
| `Gemini.MinPageTextCharCount` | int | `10` | 0–50 | 正文过短触发重试/降级 |
| `Gemini.Image.MaxLongEdgePx` | int | `2800` | 2200–3500 | 超过则等比缩放，降低超时风险 |
| `Gemini.Image.JpegQuality` | int | `90` | 80–95 | 正文页图建议 JPEG；表格图可 PNG |

---

## A1.6 Word 写入配置（OpenXML）

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `Docx.FontEastAsia` | string | `微软雅黑` | 常见中文字体 | 中文字体 |
| `Docx.FontAscii` | string | `Calibri` | 常见英文字体 | 英文字体 |
| `Docx.DefaultFontSizeHalfPoints` | int | `24` | 18–28 | 默认 12pt=24 |
| `Docx.UseStylesPart` | bool | `false` | true/false | true：写 styles.xml 更干净；MVP 可 false |
| `Docx.Table.WidthMode` | enum | `FitPageContent` | Auto/FitPageContent | 表格宽度策略 |
| `Docx.Table.SetBorders` | bool | `true` | true/false | 你要求“有表格线即可” |
| `Docx.Paragraph.KeepLineBreaks` | bool | `true` | true/false | 保留 `\n` 为 `<w:br/>` |
| `Docx.PageBreak.ModeA4` | enum | `PageBreak` | PageBreak/SectionBreak | A4 一般 PageBreak |
| `Docx.PageBreak.ModeFollowPdf` | enum | `SectionBreakNextPage` | SectionBreakNextPage | FollowPdf 必须 section break |

---

## A1.7 结果校验、重试与降级配置（与《09》对应）

| 配置键 | 类型 | 默认值 | 推荐范围/约束 | 影响/说明 |
|---|---|---:|---|---|
| `Validation.Enable` | bool | `true` | true/false | 关闭不建议，会导致 docx 风险 |
| `Validation.FailFast` | bool | `false` | true/false | true：任一页失败终止 |
| `Validation.AllowSkipFailedPages` | bool | `true` | true/false | 默认跳过失败页并汇总提示 |
| `Fallback.Table.StructureOkTextBad` | enum | `KeepStructureEmptyCells` | KeepStructureEmptyCells/FallbackTextTable | D1 策略 |
| `Fallback.Table.StructureBad` | enum | `FallbackTextTable` | FallbackTextTable/InsertImage | D2/D3 策略 |
| `Fallback.Text.Empty` | enum | `SingleParagraph` | SingleParagraph/Empty` | D4 策略 |
| `Diagnostics.SaveRawGeminiJson` | bool | `false` | true/false | 仅诊断模式，可能敏感 |
| `Diagnostics.KeepTempFiles` | bool | `false` | true/false | 勾选后保留 job 目录 |
| `Diagnostics.ExportZip` | bool | `true` | true/false | 支持导出诊断包 |

---

## A1.8 建议的 appsettings.json 示例（片段）

> 示例仅展示关键项；实际你可按模块拆分成多个 section。  
> 注意：不要在配置文件中写入明文 API Key（发布版）。

```json
{
  "Render": {
    "Dpi": 300
  },
  "Layout": {
    "HeaderFooterMode": "None",
    "HeaderPercent": 0.06,
    "FooterPercent": 0.06,
    "MaxCropTotalPercent": 0.30,
    "PageSizeMode": "FollowPdf",
    "MarginTopTwips": 1134,
    "MarginBottomTwips": 1134,
    "MarginLeftTwips": 1134,
    "MarginRightTwips": 1134
  },
  "Runtime": {
    "PageConcurrency": 2,
    "GeminiConcurrency": 2
  },
  "Preprocess": {
    "EnableDeskew": true,
    "ContrastEnhance": "CLAHE",
    "CLAHE": { "ClipLimit": 2.5, "TileGridSize": 8 },
    "Binarize": "Adaptive",
    "Adaptive": { "BlockSize": 41, "C": 10 },
    "Deskew": { "MinAngleDeg": 0.3, "MaxAngleDeg": 10.0 }
  },
  "Gemini": {
    "TimeoutSeconds": { "Table": 90, "Page": 90 },
    "MaxRetryCount": 1,
    "BackoffBaseMs": 500,
    "ExpectStrictJson": true,
    "TableMissingIdThreshold": 0.05,
    "TableEmptyTextRateThreshold": 0.80,
    "MinPageTextCharCount": 10,
    "Image": { "MaxLongEdgePx": 2800, "JpegQuality": 90 }
  },
  "Docx": {
    "FontEastAsia": "微软雅黑",
    "FontAscii": "Calibri",
    "DefaultFontSizeHalfPoints": 24,
    "UseStylesPart": false,
    "Table": { "WidthMode": "FitPageContent", "SetBorders": true },
    "Paragraph": { "KeepLineBreaks": true },
    "PageBreak": { "ModeA4": "PageBreak", "ModeFollowPdf": "SectionBreakNextPage" }
  },
  "Diagnostics": {
    "KeepTempFiles": false,
    "SaveRawGeminiJson": false,
    "ExportZip": true
  }
}
