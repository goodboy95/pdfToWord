# A2_错误码与提示文案

> 本附录定义全项目统一的错误码（Error Code）、严重级别（Severity）、所属阶段（Stage），以及面向用户的提示文案（可直接用于 UI）。  
> 目标：让用户知道“哪里出了问题、影响是什么、怎么修复”，同时让日志与诊断包能稳定定位问题。  
> 建议：错误码在日志中记录为结构化字段 `errorCode`，UI 展示使用“短提示 + 可展开详情”。

---

## A2.1 设计规范

### A2.1.1 错误码格式
- 统一格式：`E_<DOMAIN>_<NAME>`（错误） / `W_<DOMAIN>_<NAME>`（警告）
- DOMAIN 建议取值：
  - `PDF`（渲染/解析）
  - `IMG`（预处理）
  - `TABLE`（表格检测/网格）
  - `GEMINI`（网络/JSON/OCR）
  - `DOCX`（写入）
  - `IO`（文件/权限）
  - `CFG`（配置/参数）

### A2.1.2 严重级别
- `Fatal`：任务失败（无法生成可用 docx）
- `Recoverable`：可重试或可降级继续
- `Warning`：可继续，质量可能下降

### A2.1.3 UI 提示文案结构（建议）
- 标题（1 行，用户可理解）
- 影响（1 行，可选）
- 建议操作（1–3 条）
- 详情（可展开）：错误码、页码/表格索引、异常摘要（不含敏感正文）

### A2.1.4 多语言
本项目默认中文文案。若未来需要英文，可保留 `message_en` 字段。

---

## A2.2 Stage（阶段）枚举建议

| Stage | 中文显示 |
|---|---|
| `Init` | 初始化 |
| `PdfOpen` | 打开 PDF |
| `PdfRender` | 渲染页面 |
| `Crop` | 裁切页眉/页脚 |
| `Preprocess` | 图像预处理 |
| `TableDetect` | 表格检测 |
| `TableGrid` | 单元格分割/合并推断 |
| `GeminiTableOcr` | 表格文字识别（Gemini） |
| `GeminiPageOcr` | 正文识别（Gemini） |
| `AssembleIr` | 组装版面（IR） |
| `DocxWrite` | 生成 Word（docx） |
| `Finalize` | 收尾与输出 |

---

## A2.3 错误码清单（含 UI 文案）

> 说明：  
> - “触发条件”用于开发定位；  
> - “用户提示”用于 UI；  
> - “建议操作”尽量指向你已有可调参数（DPI、裁切、并发、deskew、页码范围等）。

### A2.3.1 配置与参数（CFG）

#### E_CFG_INVALID_PAGE_RANGE
- Severity：Recoverable（阻止开始）
- Stage：Init
- 触发条件：页码范围解析失败（格式非法）
- 用户提示（标题）：页码范围格式不正确
- 建议操作：
  - 请使用 `1,3,5-10` 的格式
  - 不需要转换的页可以不填或移除
- 详情：显示原始输入（可选）

#### E_CFG_PAGE_OUT_OF_RANGE
- Severity：Recoverable（建议：可阻止或允许继续，按策略）
- Stage：Init
- 触发条件：页码超出 1..totalPages
- 用户提示：页码范围包含不存在的页
- 建议操作：
  - 已忽略越界页码（若采用忽略策略）
  - 或请将页码限制在 1 到 N 页之间

#### E_CFG_CROP_TOO_LARGE
- Severity：Recoverable（阻止开始）
- Stage：Init
- 触发条件：headerPercent+footerPercent 超过上限，或裁切后高度过小
- 用户提示：页眉/页脚裁切比例过大
- 建议操作：
  - 降低页眉/页脚裁切比例（例如 6%→3%）
  - 使用“预览裁切效果”确认正文未被裁掉

---

### A2.3.2 PDF 打开/渲染（PDF）

#### E_PDF_OPEN_FAILED
- Severity：Fatal
- Stage：PdfOpen
- 触发条件：PDF 无法打开/损坏/加密不支持
- 用户提示：无法打开该 PDF 文件
- 建议操作：
  - 确认文件未损坏、未被其他程序占用
  - 若文件加密，请先解密或另存为不加密版本

#### E_PDF_GET_PAGECOUNT_FAILED
- Severity：Fatal
- Stage：PdfOpen
- 触发条件：无法获取页数
- 用户提示：无法读取 PDF 页数
- 建议操作：
  - 尝试用其他工具打开确认文件正常
  - 若仍失败，请更换渲染引擎或反馈诊断包

#### E_PDF_RENDER_FAILED
- Severity：Recoverable（单页失败可跳过）/Fatal（全部失败）
- Stage：PdfRender
- 触发条件：某页渲染异常
- 用户提示：部分页面渲染失败
- 建议操作：
  - 尝试降低 DPI（例如 400→300）
  - 若只某几页失败，可在页码范围中排除这些页再试

---

### A2.3.3 图像预处理（IMG）

#### E_IMG_PREPROCESS_FAILED
- Severity：Recoverable（单页可跳过）/Fatal（全部失败）
- Stage：Preprocess
- 触发条件：OpenCV 处理异常（内存/格式等）
- 用户提示：图像预处理失败
- 建议操作：
  - 降低 DPI 或降低并发（减少内存占用）
  - 关闭倾斜校正（deskew）后重试（高级设置）

#### W_IMG_DESKEW_SKIPPED
- Severity：Warning
- Stage：Preprocess
- 触发条件：检测角度异常（>MaxAngleDeg）自动回退不旋转
- 用户提示：已跳过倾斜校正（检测不可靠）
- 建议操作：
  - 如表格识别不稳定，可尝试关闭/开启 deskew 对比

---

### A2.3.4 表格检测与网格（TABLE）

#### W_TABLE_NOT_FOUND
- Severity：Warning
- Stage：TableDetect
- 触发条件：页内未检测到表格 bbox
- 用户提示：未检测到表格（若页面确实有表格）
- 建议操作：
  - 提高 DPI（300→400）
  - 关闭/开启 deskew
  - 确认该页表格线清晰且有边框

#### E_TABLE_DETECT_FAILED
- Severity：Recoverable（单页可继续仅正文）/Warning
- Stage：TableDetect
- 触发条件：表格检测流程异常
- 用户提示：表格检测失败（将尝试仅转换正文）
- 建议操作：
  - 降低并发或 DPI
  - 导出诊断包反馈

#### E_TABLE_GRID_INSUFFICIENT_LINES
- Severity：Recoverable
- Stage：TableGrid
- 触发条件：列线/行线数量不足（<2）导致无法建网格
- 用户提示：表格结构识别不完整
- 建议操作：
  - 提高 DPI
  - 如果线条较淡，建议先增强 PDF 清晰度（外部处理）
  - 开启“纯文本表格降级”（默认已启用）

#### E_TABLE_GRID_CONFLICT
- Severity：Recoverable
- Stage：TableGrid
- 触发条件：owner 矩阵冲突（合并推断冲突）
- 用户提示：表格合并单元格识别失败（已降级处理）
- 建议操作：
  - 提高 DPI 或开启 deskew
  - 若只某个表格失败，可接受降级结果或导出诊断包反馈

#### W_TABLE_FALLBACK_TEXT
- Severity：Warning
- Stage：TableGrid
- 触发条件：表格已降级为“纯文本表格块”
- 用户提示：部分表格已以纯文本方式输出
- 建议操作：
  - 若希望可编辑表格结构，请提高 DPI 并重试

---

### A2.3.5 AI 网络与输出（OPENAI 兼容）

#### E_GEMINI_TIMEOUT
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：请求超时
- 用户提示：识别服务请求超时
- 建议操作：
  - 降低并发（例如 4→2 或 2→1）
  - 检查网络
  - 若图片过大，降低 DPI 或启用图片缩放（默认开启）

#### E_GEMINI_RATE_LIMITED
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：HTTP 429
- 用户提示：识别服务繁忙（已自动重试）
- 建议操作：
  - 稍后重试
  - 降低并发

#### E_GEMINI_SERVER_ERROR
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：HTTP 5xx
- 用户提示：识别服务暂时不可用（已自动重试）
- 建议操作：
  - 稍后重试
  - 若频繁出现，导出诊断包反馈

#### E_GEMINI_HTTP_ERROR
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：HTTP 4xx（非 429）或其它非成功状态
- 用户提示：识别服务返回非成功状态，请检查 Base URL/模型/API Key 或网络限制
- 建议操作：
  - 检查 Base URL 是否可直连
  - 确认 API Key 正确且未过期
  - 若使用代理/网关，确认其未拦截请求

#### E_GEMINI_JSON_INVALID
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：返回内容无法解析为 JSON 或包含多余文本
- 用户提示：识别结果格式异常（已自动重试）
- 建议操作：
  - 若仍失败，可再次重试
  - 导出诊断包（含原始响应需用户确认）

#### E_GEMINI_SCHEMA_MISMATCH
- Severity：Recoverable
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：JSON 可解析但缺少必要字段/类型错误
- 用户提示：识别结果缺少必要信息（已自动重试）
- 建议操作：
  - 再次重试或降低并发

#### E_GEMINI_OCR_MISSING_IDS
- Severity：Recoverable → Warning（降级）
- Stage：GeminiTableOcr
- 触发条件：表格 OCR 结果缺失 id 超过阈值
- 用户提示：表格部分单元格未识别（已保留表格结构）
- 建议操作：
  - 提高 DPI
  - 确认表格区域清晰
  - 若仍不理想，可导出诊断包反馈

#### W_GEMINI_OCR_GARBLED
- Severity：Warning
- Stage：GeminiTableOcr / GeminiPageOcr
- 触发条件：大量 `�` 或控制字符被清理
- 用户提示：部分文字识别质量较低
- 建议操作：
  - 提高 DPI
  - 检查原 PDF 清晰度
  - 适当降低裁切比例（避免裁掉正文导致识别混乱）

#### E_GEMINI_OCR_EMPTY_TEXT
- Severity：Recoverable → Warning（降级）
- Stage：GeminiPageOcr
- 触发条件：paragraphs 为空或总字数过低
- 用户提示：正文识别结果为空（已尝试降级为单段文本）
- 建议操作：
  - 检查裁切比例是否过大
  - 尝试关闭 deskew 或提高 DPI

---

### A2.3.6 IR 组装与排序（IR）

#### E_IR_EMPTY_PAGE
- Severity：Recoverable（可跳过页）/Fatal（全部页都空）
- Stage：AssembleIr
- 触发条件：该页既无正文也无表格（或全部失败）
- 用户提示：部分页面内容为空（已跳过）
- 建议操作：
  - 检查页码范围是否选错
  - 降低裁切比例或提高 DPI

#### W_IR_BLOCK_ORDER_UNCERTAIN
- Severity：Warning
- Stage：AssembleIr
- 触发条件：部分块缺少 bbox，排序可信度低
- 用户提示：部分内容顺序可能不完全准确
- 建议操作：
  - 开启调试预览查看块顺序
  - 提高 DPI 或优化表格检测（工程侧）

---

### A2.3.7 Word 写入（DOCX）

#### E_DOCX_WRITE_FAILED
- Severity：Fatal
- Stage：DocxWrite
- 触发条件：OpenXML 写入异常，docx 可能损坏
- 用户提示：生成 Word 文件失败
- 建议操作：
  - 确认输出目录可写、磁盘空间充足
  - 关闭正在占用同名文件的 Word
  - 如反复失败，导出诊断包反馈

#### E_DOCX_TABLE_MERGE_FAILED
- Severity：Recoverable（降级为纯文本表格）/Warning
- Stage：DocxWrite
- 触发条件：合并单元格写入失败或结构不合法
- 用户提示：部分表格写入失败（已降级为纯文本）
- 建议操作：
  - 提高 DPI 改善表格结构识别
  - 若仍不理想，导出诊断包

---

### A2.3.8 文件与权限（IO）

#### E_IO_OUTPUT_PATH_NOT_WRITABLE
- Severity：Fatal（开始前可阻止）
- Stage：Init / Finalize
- 触发条件：输出目录不可写/无权限/路径非法
- 用户提示：无法写入输出目录
- 建议操作：
  - 更换输出目录（例如桌面）
  - 以管理员权限运行（不推荐作为首选）
  - 检查磁盘空间

#### E_IO_DISK_FULL
- Severity：Fatal
- Stage：Finalize
- 触发条件：磁盘空间不足导致写入失败
- 用户提示：磁盘空间不足，无法完成输出
- 建议操作：
  - 清理磁盘空间后重试
  - 更换输出目录到空间充足的磁盘

#### W_IO_TEMP_CLEANUP_FAILED
- Severity：Warning
- Stage：Finalize
- 触发条件：临时目录清理失败（文件占用）
- 用户提示：临时文件未能自动清理
- 建议操作：
  - 关闭占用文件的程序后再点击“清理临时文件”
  - 或稍后重启再清理

---

## A2.4 结果摘要模板（转换完成后的汇总）

### A2.4.1 成功（无警告）
- 标题：转换完成
- 内容：已生成 Word 文件：`xxx.docx`
- 操作：打开文件 / 打开目录

### A2.4.2 成功（有警告）
- 标题：转换完成（部分内容质量可能下降）
- 内容：
  - 第 3 页：`W_TABLE_FALLBACK_TEXT`（表格已降级为纯文本）
  - 第 7 页：`W_GEMINI_OCR_GARBLED`（文字识别质量较低）
- 建议：提高 DPI、调整裁切比例、导出诊断包

### A2.4.3 部分失败（跳过页）
- 标题：转换完成（已跳过部分页面）
- 内容：
  - 跳过页：7（`E_IR_EMPTY_PAGE`）
- 建议：检查页码范围、裁切比例、DPI

### A2.4.4 失败（Fatal）
- 标题：转换失败
- 内容：错误码 + 简要原因（不含敏感正文）
- 建议：按错误码对应建议操作
- 操作：导出诊断包（可选）

---

## A2.5 UI 文案落地建议

- 主界面错误提示：使用 `E_CFG_*` 文案，阻止开始
- 运行中错误：尽量写入日志与“失败页列表”，避免频繁弹窗
- 结束后：弹出/展示“结果摘要”，并提供“复制日志/导出诊断包”按钮

---

## A2.6 结构化输出建议（供日志/诊断包）

建议在日志或诊断 JSON 中包含：

```json
{
  "jobId": "20251227_001",
  "page": 3,
  "table": 1,
  "stage": "GeminiTableOcr",
  "severity": "Recoverable",
  "errorCode": "E_GEMINI_JSON_INVALID",
  "message": "Invalid JSON response",
  "attempt": 2,
  "elapsedMs": 91234
}
