# 04_用户交互与 UI 设计

## 4.1 文档目的

本文档定义 WPF 桌面端软件的用户交互流程与 UI 设计规范，确保：

* 用户能快速完成“选择 PDF → 指定页 → 选择去页眉页脚 → 选择页面尺寸 → 输出 docx”
* 关键参数（页码范围、裁切比例、DPI/并发）可配置但不干扰新手使用
* 转换过程有明确进度反馈、可取消、可定位失败页
* 对“页眉页脚裁切”和“表格检测效果”提供必要的预览能力，便于调参提升质量
* UI 与核心逻辑（Core）解耦（MVVM），便于维护与测试

---

## 4.2 设计目标与原则

### 4.2.1 目标用户

* 需要将扫描型/图片型 PDF 转为可编辑 Word 的非技术/半技术用户
* 期望少量参数、可一键转换，但遇到质量问题可调参

### 4.2.2 设计原则

1. **主流程一屏完成**：主要参数放在主界面即可完成转换
2. **高级选项折叠**：DPI/并发/deskew 等放在“高级设置”
3. **错误可解释可修复**：明确告诉用户“哪里失败、怎么改”
4. **预览用于调参**：重点支持裁切预览与表格框预览
5. **不阻塞 UI**：转换全程异步，进度实时更新，可取消

---

## 4.3 信息架构（页面/窗口结构）

建议采用单窗口 + 多区域布局（或 Tab）：

1. **主界面（MainView）**：输入与参数设置、开始按钮
2. **进度与日志面板（ProgressPanel）**：实时进度、当前阶段、日志列表、取消
3. **预览面板（PreviewPanel）（建议）**：显示选定页渲染图、裁切区域、表格框/单元格框叠加
4. **结果与报告（ResultPanel）**：输出路径、打开文件、失败页列表、导出诊断包（可选）

> 如果你偏简洁：主界面 + 一个“预览/日志”抽屉式面板也可。

---

## 4.4 主流程交互（Happy Path）

### 4.4.1 用户操作步骤

1. 点击 **选择 PDF** → 显示文件路径与页数（读取页数后展示）
2. 输入 **页码范围**（可为空=全部页）
3. 选择 **页眉页脚去除模式**
4. 选择 **页面尺寸模式**（A4 或跟随 PDF）
   5)（可选）设置裁切比例、DPI、并发等
5. 点击 **开始转换**
6. 显示进度（页数、当前页、阶段）
7. 完成后显示输出路径，提供 **打开 Word**、**打开输出目录**

### 4.4.2 默认值建议（降低用户决策成本）

* 页码范围：空（全部页）
* 去页眉页脚：不去除（用户明确需要才开）
* headerPercent / footerPercent：0.06 / 0.06（仅当去除模式开启时生效）
* 页面尺寸：跟随 PDF（更贴近原文），但可在 UI 说明“若排版不稳定可选 A4”
* DPI：300
* 并发：2
* deskew：开启（高级选项）

---

## 4.5 主界面布局（控件清单与行为）

### 4.5.1 文件选择区

* Label：`输入 PDF`
* TextBox（只读）：显示路径
* Button：`选择...`
* 信息标签：显示页数、文件大小（可选）

**行为：**

* 选择 PDF 后立即读取页数（后台任务），失败则提示错误

### 4.5.2 页码范围区

* Label：`转换页码范围`
* TextBox：支持输入 `1,3,5-10`
* Placeholder：`留空=全部页；例如 1,3,5-10`
* 小提示：当输入非法时红色提示 + “示例”

**行为：**

* 输入实时校验（失焦或点击开始时）
* 解析成功后可显示“将转换：第 1,3,5-10 页（共 N 页）”

### 4.5.3 页眉页脚去除区

* Label：`去除页眉页脚`
* RadioButtons 或 ComboBox：

  * 不去除
  * 去页眉
  * 去页脚
  * 全部去除

当选择非“不去除”时，展开参数：

* Slider/TextBox：`页眉裁切比例`（0–20%）
* Slider/TextBox：`页脚裁切比例`（0–20%）
* Button：`预览裁切效果`（见 4.6）

**行为：**

* “去页眉”只启用 headerPercent
* “去页脚”只启用 footerPercent
* “全部去除”两者启用
* 输入限制：header+footer 不得超过 50%（超出给出错误提示并禁止开始）

### 4.5.4 页面尺寸区

* Label：`Word 页面尺寸`
* RadioButtons：

  * 强制 A4
  * 与 PDF 页一致（跟随 PDF）

**提示文案建议：**

* 跟随 PDF：更接近原文，但如果 Word 打开后页面显示异常可尝试 A4
* 强制 A4：统一版式，适合公司模板/打印

### 4.5.5 高级设置（折叠面板 Expander）

* DPI：ComboBox（200/300/400）
* 并发：ComboBox（1/2/4）
* deskew：CheckBox（默认勾选）
* 保留诊断文件：CheckBox（默认不勾选）
* 输出目录：默认与 PDF 同目录或用户上次路径（可配置）

### 4.5.6 操作按钮区

* 主按钮：`开始转换`
* 次按钮：`取消`（转换中显示）
* 转换完成后按钮：

  * `打开 Word`
  * `打开输出文件夹`

按钮状态逻辑：

* 未选择 PDF 或参数非法：开始按钮 Disabled
* 转换中：开始 Disabled，取消 Enabled
* 完成/失败：开始 Enabled（允许重新转换），取消 Disabled

---

## 4.6 预览设计（关键：裁切与表格框）

预览不是必须 MVP，但你要求“尽量保持格式一致”，裁切与表格检测是否正确是关键，因此强烈建议至少提供简单预览。

### 4.6.1 预览入口

* 主界面：`预览裁切效果`按钮
* 或单独 “预览” 标签页

### 4.6.2 预览内容

预览面板建议包含：

1. 页选择器：

* NumericUpDown / Slider：选择预览页（默认第 1 页或用户输入范围第一页）

2. 图像显示区：

* 显示渲染页图（建议显示裁切前/裁切后切换）

3. 叠加层（Overlay）：

* 裁切区域（半透明遮罩）
* 表格 bbox 框（可选开关）
* 单元格 bbox 框（可选，调试用）

4. 控制项：

* Toggle：显示/隐藏表格框
* Toggle：显示/隐藏单元格框（高级）
* Button：`重新渲染预览`（当 DPI 或裁切比例调整后）

### 4.6.3 预览的技术实现建议

* 渲染流程：调用同一套 `PdfRenderer` 与 `Cropper`（与真实转换一致）
* 叠加绘制：

  * WPF `Canvas` + `Rectangle` 绘制 bbox
  * 或使用 `Adorner` 实现更高级叠加
* 性能：

  * 预览只处理单页即可
  * 表格检测预览可以只跑 bbox 检测，不必完整单元格分割（也可做“高级预览”）

---

## 4.7 进度与日志（Progress & Logging UI）

### 4.7.1 进度展示元素

* 总进度条：完成页数 / 目标页数
* 当前页信息：`正在处理第 X 页 / 共 Y 页`
* 当前阶段：枚举显示，例如：

  * 渲染
  * 裁切
  * 预处理
  * 表格检测
  * 单元格分割
  * 表格文字识别（Gemini）
  * 正文识别（Gemini）
  * 写入 Word
* 耗时（可选）：当前页耗时、总耗时

### 4.7.2 日志列表

* 列表显示最近 N 条日志（滚动）
* 每条日志包含：

  * 时间
  * level（Info/Warning/Error）
  * 内容（简明）
  * page/table 上下文（如 `P3 T1`）

可选功能：

* “复制日志”
* “导出诊断包”（若开启保留诊断文件）

### 4.7.3 失败列表（强烈建议）

转换完成后显示：

* 失败页列表：`第 7 页：表格结构冲突，已降级为纯文本表格`
* 失败原因简述（对应错误码映射）
* 提示建议：

  * 提高 DPI
  * 调整裁切比例
  * 关闭/开启 deskew
* 按钮（可选增强）：

  * `重试失败页`
  * `仅重试第 X 页`

---

## 4.8 交互细节：错误提示与可修复性

### 4.8.1 参数校验（开始前）

必须校验：

* PDF 路径存在且可读
* 页码范围合法且落在 [1..pageCount]
* 裁切比例合法：

  * `headerPercent`、`footerPercent` 在 0..0.2
  * `header+footer <= 0.5`（建议更严格：<=0.3）
* 输出路径可写

提示风格：

* 就地提示（红字）优先，避免弹窗打断
* 开始按钮旁显示总错误摘要（如“请修正 2 个参数错误”）

### 4.8.2 运行中错误提示

* 不要频繁弹窗
* 错误写入日志 + 状态条提示
* 任务结束时统一汇总弹出或显示“结果摘要”

### 4.8.3 用户可操作的修复建议（模板）

* “表格结构识别失败：建议提高 DPI 至 400 或开启 deskew”
* “正文识别为空：建议检查是否裁切比例过大”
* “请求超时：建议降低并发或检查网络”

---

## 4.9 MVVM 设计建议（ViewModel 与命令）

### 4.9.1 主要 ViewModel

* `MainViewModel`

  * 输入：PdfPath、PageRangeText、HeaderFooterMode、HeaderPercent、FooterPercent、PageSizeMode
  * 高级：Dpi、Concurrency、DeskewEnabled、KeepDiagnostics
  * 输出：OutputPath
  * 状态：IsBusy、CanStart、CanCancel、Progress、CurrentStage、Logs、FailedPages
  * 命令：BrowsePdfCommand、PreviewCommand、StartCommand、CancelCommand、OpenOutputCommand

* `PreviewViewModel`（若分离）

  * PreviewPageNumber、PreviewImage、OverlayBoxes、IsShowTables、IsShowCells
  * 命令：RenderPreviewCommand、DetectTablesCommand

### 4.9.2 命令与状态管理

* StartCommand 执行时：

  * 禁用输入控件
  * 建立 CancellationTokenSource
  * 调用 Core `ConvertAsync`，订阅 progress 回调更新 UI
* CancelCommand：

  * `cts.Cancel()`，UI 显示“正在取消...”
* 完成后：

  * 恢复输入控件
  * 显示结果摘要

---

## 4.10 无障碍与可用性细节（建议）

* 所有输入控件有明确 Label
* 页码范围输入框提供示例与 tooltip
* Slider 同步显示百分比数字（用户更易理解）
* 日志默认自动滚动到最新，允许用户暂停滚动（可选）
* 支持拖拽 PDF 到窗口（可选增强）

---

## 4.11 UI 验收点

* 不看文档也能完成转换（主流程清晰）
* 页码范围输入可正确解析并提示非法输入
* 去页眉页脚选项可用，裁切比例可调，预览能直观看到裁切区域
* 页面尺寸可选 A4 / 跟随 PDF
* 转换过程中有明确进度与阶段显示，可取消
* 转换结束后可打开结果，失败页有汇总与建议
* UI 全程不卡死（长任务在后台运行）
