# 01_需求与范围

## 1.1 文档目的

本文档用于明确本软件的**功能需求、非功能需求、输入输出范围、约束与不做范围**，作为后续架构设计、模块开发与测试验收的依据。

---

## 1.2 背景与问题陈述

### 背景

目标 PDF 为“图片型/扫描型 PDF”：每页都是一张图片。内容仅包含：

* 中文为主，夹杂少量英文字母、数字、符号
* 文字段落
* 带边框线的文字表格（经常出现合并单元格）

### 当前痛点

* Word 自带 PDF→Word 转换对该类扫描 PDF 效果差：格式错乱、乱码、表格结构不稳定。
* 用户需要一种低成本、可控、可调参、支持局部重试的桌面工具，将 PDF 快速转换为可编辑的 Word 文档。

---

## 1.3 产品目标（What success looks like）

### 目标

在不额外购买商业 OCR/Document AI 服务的前提下（仅使用 Gemini API），实现一个 Windows 桌面端工具，满足：

* 文本内容与表格内容 **大致正确**（可读、可编辑、少量错误可接受）
* 表格结构 **尽量正确**（行列与合并单元格不严重错乱）
* 输出 Word 的整体版式 **尽量接近原文**（保留分页、段落分段、表格位置顺序）
* 支持用户选择转换页、去除页眉页脚、选择页面尺寸（A4/跟随 PDF）
* 遇到异常具备可解释的失败提示与可重试能力

### 关键原则

* **结构可控**：表格结构由算法推断，Gemini 主要做文字识别回填
* **可校验可重试**：对输出 JSON/表格结构进行校验，失败仅重试局部块
* **可调参可预览**：页眉/页脚裁切比例可调整，必要时可预览检测框

---

## 1.4 输入范围（Input scope）

### 支持的输入

* 文件类型：`.pdf`
* PDF 内容特征：

  * 每页为整页图片（扫描件/截图型），不是原生可选中文本 PDF
  * 内容主要为文字与**带边框线的表格**
  * 中文为主，允许夹杂字母数字

### 不保证支持的输入（可允许导入但结果不保证）

* 多栏排版、复杂版面（文本绕排、浮动对象）
* 含大量图片、图表、公式、手写、印章/水印遮挡
* 表格无边框线（靠对齐的“伪表格”）
* 极度模糊、强透视扭曲、强噪声、严重倾斜且无法自动校正的扫描件
* 加密 PDF 或禁止渲染/复制的 PDF（视渲染库能力而定）

---

## 1.5 输出范围（Output scope）

### 输出文件

* Word 文档：`.docx`

### 输出内容与版式目标

* **分页**：每个 PDF 页对应 Word 的一个分页（PageBreak）
* **段落**：

  * 尽量保持原文分段与换行
  * 可选识别标题并映射为标题样式（Heading1/Heading2 或自定义）
* **表格**：

  * 具有表格线（无需模拟原线条粗细）
  * 行列结构尽量正确
  * 合并单元格（rowspan/colspan）尽量正确
* **页面尺寸**：

  * 用户可选：强制 A4 或与 PDF 页一致（按比例映射）
* **页眉页脚**：

  * 用户可选：不去除 / 去页眉 / 去页脚 / 全部去除
  * 去除方式以裁切为主，并提供可调百分比（默认值见附录配置表）

---

## 1.6 功能需求（Functional Requirements）

以下需求按优先级分为 **必须（P0）/重要（P1）/增强（P2）**。

### 1.6.1 文件与任务流程

**FR-001 (P0)**：选择 PDF 文件作为输入。
**FR-002 (P0)**：支持输出路径选择与 docx 保存。
**FR-003 (P0)**：提供“开始转换/取消转换”按钮。
**FR-004 (P0)**：显示转换进度（总页数、已完成页数、当前处理阶段）。
**FR-005 (P1)**：支持失败提示（失败页、失败原因概要）与建议操作。
**FR-006 (P2)**：支持对失败页/失败表格块进行重试入口。

### 1.6.2 页码范围选择

**FR-010 (P0)**：支持用户输入页码范围字符串，语法至少包括：

* 单页：`3`
* 列表：`1,3,8`
* 区间：`5-10`
* 组合：`1,3,5-10`
* 容忍空格：`1, 3, 5-10`
  **FR-011 (P0)**：空输入表示全部页。
  **FR-012 (P0)**：页码从 1 开始，越界页码应提示或忽略（需在设计中确定策略）。
  **FR-013 (P1)**：对非法输入应给出错误提示，并阻止开始或给出修正建议。

### 1.6.3 页眉页脚去除

**FR-020 (P0)**：提供选项：

* 不去除
* 去页眉
* 去页脚
* 全部去除
  **FR-021 (P0)**：去除采用裁切方式（Crop），裁切比例可配置。
  **FR-022 (P1)**：提供页眉/页脚裁切比例输入（例如 0–20%），具备合理默认值。
  **FR-023 (P2)**：提供预览：显示裁切区域，便于用户调参。

### 1.6.4 页面尺寸输出

**FR-030 (P0)**：提供选项：

* 强制 A4
* 与 PDF 页一致（按比例映射）
  **FR-031 (P1)**：当选择“与 PDF 页一致”，应尽量保留宽高比例，并设置合理边距。
  **FR-032 (P2)**：可提供边距设置选项（默认值即可）。

### 1.6.5 转换质量（文本与表格）

**FR-040 (P0)**：对每个目标页完成文本识别并写入 Word。
**FR-041 (P0)**：对检测到的表格完成结构还原与文字填充，写入 Word 表格。
**FR-042 (P0)**：支持合并单元格（rowspan/colspan）写入 Word（OpenXML）。
**FR-043 (P1)**：支持标题/正文样式区分（若无法稳定识别，可先弱化）。
**FR-044 (P1)**：保留原文换行（段内 `\n`）与段落分隔。
**FR-045 (P1)**：支持过滤明显乱码字符（不可见控制字符等）。

### 1.6.6 处理配置（可选）

**FR-050 (P1)**：提供 DPI 设置（200/300/400），默认 300。
**FR-051 (P1)**：提供并发设置（1/2/4），默认 2。
**FR-052 (P2)**：允许用户选择是否启用 deskew（默认启用）。

### 1.6.7 诊断与可观测性（建议但可分阶段）

**FR-060 (P1)**：输出过程日志（阶段、耗时、错误信息）。
**FR-061 (P2)**：诊断包导出（中间图片、JSON、日志）用于定位问题。
**FR-062 (P2)**：预览叠加表格框、单元格框。

---

## 1.7 非功能需求（Non-Functional Requirements）

### 1.7.1 平台与兼容性

**NFR-001**：仅支持 Windows 10/11。
**NFR-002**：采用 WPF (.NET 8) 桌面应用。

### 1.7.2 性能

**NFR-010**：典型文档（10–20 页、300 DPI）应在合理时间内完成（具体指标可在验收文档中量化）。
**NFR-011**：并发处理不应导致 UI 卡死；后台任务需可取消。
**NFR-012**：应控制内存占用，避免一次性加载全部页的高分辨率位图常驻内存。

### 1.7.3 稳定性与容错

**NFR-020**：单页失败不应导致全任务崩溃；应记录失败并继续或中止（策略需定义）。
**NFR-021**：对 Gemini 返回的内容必须校验（JSON/结构），不可信输入要拒绝并触发重试/降级。
**NFR-022**：支持局部重试（表格块/正文块）与降级输出（至少可读）。

### 1.7.4 可维护性

**NFR-030**：提示词、默认参数、阈值应尽量配置化（不硬编码在 UI 代码）。
**NFR-031**：模块边界清晰（PDF、OpenCV、Gemini、Word）可独立替换。
**NFR-032**：核心算法（表格检测/单元格分割）应有可重复调试与测试样例。

### 1.7.5 安全与隐私

**NFR-040**：允许发送内容到 Gemini（已确认），但应避免在日志中记录敏感正文。
**NFR-041**：API Key 本地存储需加密或至少避免明文落盘（发布版要求）。
**NFR-042**：临时文件与缓存需可清理，默认任务结束后可自动清理或提供按钮。

---

## 1.8 范围边界（Out of scope）

以下内容明确不在当前版本目标中（避免范围蔓延）：

* 完全 1:1 复刻原文排版（字体/字号/字距/表格线粗细等细节）
* 复杂版面对象：图片、图表、公式、文本框、批注、脚注精确还原
* 多栏阅读顺序的完美推断
* 对无边框“对齐型表格”的可靠结构识别
* 完全离线识别（当前依赖 Gemini 云端能力）

> 若未来要扩展，可在后续版本引入更强的版面分析模型或商业 Document AI 服务。

---

## 1.9 依赖与约束

### 外部依赖

* Gemini API 可用且网络稳定
* PDF 渲染库可稳定输出高分辨率页图
* OpenCvSharp 运行时可随安装包正确部署

### 主要约束

* 成本控制：不引入额外付费 OCR 服务作为必选依赖
* 输出“尽量接近原文”，但优先级为：

  1. 阅读顺序正确
  2. 表格结构/合并尽量正确
  3. 分页一致
  4. 段落换行与分段尽量保留
  5. 再考虑细节样式

---

## 1.10 验收口径（概要，详细见测试文档）

* 页码范围功能正确：`1,3,5-10` 能准确选择页
* 去页眉/页脚裁切有效且可调
* A4/跟随 PDF 两种页面尺寸输出可用
* 对典型样例（含合并单元格表格）：

  * 表格能正确生成并可编辑
  * 合并单元格不出现严重错位（如整行错乱、列数乱跳）
  * 文本基本可读，少量识别错误可接受
* 失败场景有提示、不中断 UI、可取消
