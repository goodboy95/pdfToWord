# 工程与运维（12–16 合并版）

> 覆盖内容：性能/并发/缓存/任务调度、日志与可观测性/调试预览、测试与验收、部署打包发布、以及安全与隐私合规。
> 适用：Win10/11、WPF、.NET 8、OpenCvSharp、OpenXML、Gemini API。

---

## 12. 性能、并发、缓存与任务调度

### 12.1 性能目标与约束（建议口径）

* 典型规模：10–20 页、300 DPI、含若干表格（含合并单元格）
* 目标体验：

  * UI 始终可操作（不卡死）
  * 进度持续更新（不“长时间无反馈”）
  * 失败可定位并可局部重试（不需重跑整本）
* 约束：

  * 图片型 PDF：渲染/图像处理是主要 CPU & 内存消耗
  * Gemini 网络调用是主要不确定性来源（超时、限流、偶发非 JSON）

### 12.2 并发模型（推荐实现）

并发拆两层：**页级并发** 与 **Gemini 请求并发**，二者应分别限流。

#### 12.2.1 页级并发（CPU/内存主导）

* 默认：2
* 可配置：1 / 2 / 4
* 建议规则：

  * 页并发越高，内存峰值越高（多张高 DPI 位图同时存在）
  * 若用户选 400 DPI，默认将页并发自动下调至 1 或 2（可作为自动建议/警告）

#### 12.2.2 Gemini 请求并发（网络/限流主导）

* 默认：2（全局 `SemaphoreSlim(2)`）
* 目的：

  * 控制 429/超时风险
  * 避免同一时间大量请求导致整体失败率上升
* 建议：表格 OCR 与正文 OCR 共用同一个限流器（统一控制）

### 12.3 任务调度与状态管理

#### 12.3.1 Job / Page / Block 的调度顺序（建议）

* 按用户页码范围得到目标页列表（已排序）
* 为每页创建 `PageTask`
* `PageTask` 内部流程：

  1. PDF 渲染与裁切（CPU+IO）
  2. 预处理与表格检测/单元格分割（CPU）
  3. 表格 OCR（Gemini，受全局限流）
  4. 正文 OCR（Gemini，受全局限流）
  5. 组装 Page IR
* 页面之间可并发，但建议：

  * **单页内表格 OCR 默认串行**（减少 Gemini 并发压力）
  * 若要并行表格 OCR，仍必须受全局限流控制

#### 12.3.2 取消（Cancel）

* UI 触发 `CancellationTokenSource.Cancel()`
* 所有阶段都要检查 token，尤其是：

  * 渲染前后
  * OpenCV 计算前后
  * Gemini 请求前（请求中则依赖超时+取消）
  * docx 写入前
* 取消后的输出策略：

  * 默认：不输出 docx（避免半成品），或输出“已完成页”版本（可选增强）
  * 建议 MVP：取消即终止并提示“已取消，未生成输出”

### 12.4 缓存策略（强烈建议）

缓存是提高稳定性与调试效率的关键：失败可重跑，样例可回归。

#### 12.4.1 缓存内容分层

* **必须缓存（建议默认）**

  * `pXXX_cropped.png`：裁切后页图（后续所有算法可复用）
* **建议缓存（可选开关：保留诊断文件）**

  * `pXXX_binary.png`：二值图
  * `pXXX_tables.json`：表格 bbox / grid / cell bbox（结构）
  * `pXXX_masked.png`：遮罩表格后的页图
  * `pXXX_ir.json`：页 IR
  * `gemini_raw_*.json`：原始返回（仅诊断模式）

#### 12.4.2 目录结构建议

```
%TEMP%\Pdf2Word\job_{jobId}\
  pages\
    p001_render.png
    p001_cropped.png
    p001_binary.png
    p001_masked.png
  tables\
    p001_t00_color.png
    p001_t00_grid.json
  ir\
    p001_ir.json
    doc_ir.json
  logs\
    job.log
  meta.json
```

#### 12.4.3 清理策略

* 默认：任务结束后自动清理临时目录
* 若用户勾选“保留诊断文件”：保留本次 job 目录，并提供“导出诊断包(zip)”入口
* 可选增强：保留最近 N 次（比如 5 次），超出自动清除

### 12.5 内存与 IO 控制

* 大图不要在内存中“全页常驻”

  * 做完一个页的 OpenCV 与 Gemini 前置准备后，可释放不再需要的 Bitmap/Mat
* 图片落盘的时机：

  * 若内存压力大（400 DPI + 并发高），优先落盘 PNG/JPEG 再读取
* 建议实现一个 `ITempStorage`，集中管理：

  * 文件命名
  * 生命周期清理
  * 写入失败处理（磁盘满/无权限）

---

## 13. 日志、可观测性、调试与预览

### 13.1 日志目标

* 用户角度：知道“现在在做什么、卡在哪、怎么解决”
* 开发角度：定位“是渲染问题、表格结构问题、Gemini 输出问题、还是 OpenXML 写入问题”
* 诊断角度：能复现（同一页/同一表格可重跑）

### 13.2 日志分级与结构化字段

#### 13.2.1 分级

* INFO：阶段开始/结束、耗时、页进度
* WARN：可继续但质量下降（缺 cell、降级输出、线条弱）
* ERROR：该块/该页失败、触发重试/降级原因
* FATAL：任务失败（无法输出）

#### 13.2.2 建议的结构化字段（务必）

* `jobId`
* `page`（1-based）
* `table`（0-based 或 tXX）
* `stage`（render/crop/preprocess/table_detect/grid/ocr_table/ocr_text/docx）
* `attempt`（重试次数）
* `elapsedMs`
* `errorCode`（如 `E_GEMINI_JSON_INVALID`）

### 13.3 关键埋点（必须有）

* Job：开始、结束、取消、失败原因
* 每页：开始、结束、耗时
* 表格：

  * bbox 检测数量
  * grid 行列数、cell 数、owner 冲突与否
* Gemini：

  * 请求类型（T1/T2）
  * 图片尺寸、cells 数量
  * 解析/校验结果：缺失率、空文本率、JSON 解析失败原因
  * 429/超时/5xx 统计

### 13.4 预览与调试可视化（建议做，提升调参效率）

#### 13.4.1 用户预览（面向调参）

* 裁切预览：叠加显示页眉/页脚裁切区域
* 表格 bbox 预览：显示检测到的表格框（可开关）

#### 13.4.2 开发预览（面向算法调试，可放“高级/调试模式”）

* 单元格 bbox 叠加
* 行列边界线（colLinesX/rowLinesY）
* 输出 mask 图（horizontal/vertical/grid/cellFill）

### 13.5 诊断包（强烈建议）

“导出诊断包”应包含：

* 日志（job.log）
* 失败页/失败表格对应的中间图片与 grid.json
* page ir / doc ir
* 可选：Gemini raw json（仅用户确认且开启诊断模式）

> UI 提示要明确：诊断包可能包含文档内容，注意隐私。

---

## 14. 测试计划与验收标准

### 14.1 测试分层

#### 14.1.1 单元测试（必须）

* 页码范围解析（05 规范）
* 表格结构校验：

  * `sum(colspan)==NCols`
  * owner 矩阵无冲突
  * rowspan/colspan 越界
* 文本清洗（控制字符过滤、U+FFFD 比例检查）
* 像素→twips 换算（页面尺寸映射正确）

#### 14.1.2 集成测试（建议）

* 给定固定 PDF 样例集：

  * 运行转换得到 docx
  * 关键断言：

    * docx 可打开（OpenXML 验证 + 人工抽检）
    * 关键页存在分页
    * 表格数量与页内顺序合理
* 可选：对 IR JSON 做快照对比（结构回归比 docx 更稳定）

#### 14.1.3 回归测试（建议）

* 建立“样例库”（建议至少 20 份，覆盖常见变体）：

  * 表格密集、合并单元格多
  * 线条很细
  * 页眉页脚干扰明显
  * 小字多
  * 横向页面
* 每次算法改动，跑一遍回归（可半自动：输出诊断指标 + 抽检）

### 14.2 样例集与标注建议

* 每份 PDF 对应：

  * 基本信息（页数、DPI、表格数量预估）
  * 人工期望点（某页某表合并关系、关键字段是否识别）
* 不要求逐字标注 GT（成本太高），推荐“关键字段抽检”：

  * 表格中 5~10 个关键 cell
  * 正文 1~2 段关键句

### 14.3 验收标准（可执行口径）

**功能验收**

* 页码范围：`1,3,5-10` 正确选页
* 去页眉/脚：裁切生效且可调，预览一致
* 页面尺寸：A4/跟随 PDF 都可输出

**质量验收（建议阈值）**

* 表格结构：

  * 合并单元格“严重错乱”（整表列数乱跳、错位覆盖）比例应极低
  * 对样例集：≥80% 表格结构“可用”（可编辑、合并大体正确）
* 文本：

  * 正文可读，乱码（不可见控制符/大量�）应被过滤或触发重试/降级
* 稳定性：

  * 连续跑 10 次同一 PDF，成功率 ≥ 90%（网络稳定条件下）

**体验验收**

* UI 不冻结
* 进度阶段有更新
* 失败页有汇总与建议

---

## 15. 部署、打包与发布

### 15.1 打包方式建议（Win10/11）

优先级建议：

1. **MSIX**（推荐）：现代、安装卸载干净、可签名、可更新（需要一定配置）
2. ClickOnce：部署简单，但对依赖/native 打包要小心
3. Zip 绿色版：最简单，但依赖与 VC++ runtime 等可能麻烦

> 若你希望最省事：先 Zip 版 MVP；产品化再 MSIX。

### 15.2 Native 依赖与随包策略（关键）

本项目可能包含：

* OpenCvSharp runtime（`OpenCvSharp4.runtime.win`）
* PDF 渲染库 native（如 pdfium）
  必须确保：
* x64 统一（建议只支持 x64）
* 发布包中 native dll 位于可被加载的位置（通常与 exe 同目录或 runtimes\win-x64\native）

建议：

* `dotnet publish -c Release -r win-x64 --self-contained false`（或 true 视需求）
* 在 CI 中做一次“干净机”验证（新机器运行不缺 dll）

### 15.3 版本管理与发布流程

* 语义化版本：`MAJOR.MINOR.PATCH`

  * PATCH：修 bug、调参
  * MINOR：新增功能（预览增强、重试策略改进）
  * MAJOR：破坏性变更（IR 版本大改）
* 发布清单（Release checklist）：

  * 样例集回归通过
  * 诊断包导出可用
  * docx 可打开验证
  * 安装包签名（如需）
  * 更新日志（Changelog）

### 15.4 更新策略（可选）

* 初期可人工下载替换
* 若 MSIX：可配置更新源
* 若要内置更新：要考虑签名、下载源安全（HTTPS、校验 hash）

---

## 16. 安全与隐私合规

> 你已明确允许发 Gemini，但仍需要“最小化泄露、可解释、可控制”的策略，尤其是诊断与日志部分。

### 16.1 数据流与边界

* 本地处理：

  * PDF 渲染、裁切、OpenCV、OpenXML 生成、缓存（临时）
* 发送到 Gemini：

  * 表格裁剪图（T1）
  * 遮罩表格后的页图（T2）
* 不发送：

  * API Key（当然）
  * 用户机器信息（除非日志里有，建议避免）
  * 诊断包默认不上传任何地方（纯本地）

### 16.2 API Key 管理（必须）

目标：避免明文落盘，避免日志泄露。

建议方案（从易到稳）：

1. UI 输入 Key（推荐）
2. 使用 Windows DPAPI 加密后存储到本地配置（CurrentUser）
3. 允许环境变量覆盖（便于企业部署）

禁止：

* 把 Key 写入日志
* 以明文写入 json 配置（发布版）

### 16.3 日志与诊断文件的隐私策略

* 默认日志不记录正文内容，只记录统计与错误码
* 诊断包默认不包含 Gemini 原始返回与完整文本
* 若用户勾选“保留诊断文件/包含原始响应”：

  * UI 明确提示“可能包含敏感内容”
  * 允许用户一键清理

### 16.4 临时文件生命周期

* 默认任务结束后清理临时目录
* 若保留诊断文件：

  * 提供“清理”按钮
  * 可设置保留天数（例如 7 天自动清理）

### 16.5 网络安全（建议）

* 仅使用 HTTPS 调用 Gemini
* 对请求超时、429 做合理退避，避免“异常时疯狂重试”造成风险
* 处理异常时不要把完整请求体（含图片 base64）写入日志

---

## 附：工程配置建议（便于落地）

### A. 配置项建议集中管理

* `appsettings.json`（或自定义配置文件）用于默认值
* UI 保存“用户偏好”（最近路径、DPI、并发、裁切比例）到本地 user scope
* 任务级配置写入 `DocumentMeta.Options`（用于复现）

### B. CI 建议（可选）

* Build（Release, win-x64）
* Unit Tests
* 打包产物上传（MSIX/Zip）
* 可选：跑一份小样例集的集成测试（不连 Gemini，或用 mock）
